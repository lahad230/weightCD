---

- hosts: staging
  become: yes
  tasks:

  - name: update nodejs package 
    ansible.builtin.shell: curl -fsSL https://deb.nodesource.com/setup_15.x | sudo -E bash -

  - name: install nodejs
    apt:
      name: nodejs
      state: present

  - name: install zip
    apt:
      name: zip
      state: present

  - name: Creates directory
    file:
      path: /src/www
      state: directory

  # - name: getting artifact
  #   ansible.builtin.unarchive:
  #     src: http://10.0.0.4:8080/job/weightCI/lastSuccessfulBuild/artifact/latest.zip
  #     dest: /src/www
  #     remote_src: yes    

  - name: Download artifact
    get_url:
      url: http://10.0.0.4:8080/job/weightCI/lastSuccessfulBuild/artifact/latest.zip
      dest: /src/www
      force_basic_auth: yes
      username: smallpox
      password: 11672cb09384ada7e9e51ff1ad539dba0e

  - name: Extract artifact
    ansible.builtin.unarchive:
      src: /src/www/latest.zip
      dest: /src/www
      remote_src: yes

  - name: create .env
    ansible.builtin.script: /src/www/buildEnv.sh -u {{ url }} -i {{ id }} -s {{ secret }} -h {{ db_host }} -p {{ pass }} -n {{ user }}
      remote_src: yes

  - name: initialize db
    ansible.builtin.shell: node /src/www/tools/initdb.js

  - name: run app
    ansible.builtin.shell: node /src/www/src/index.js

# 11672cb09384ada7e9e51ff1ad539dba0e